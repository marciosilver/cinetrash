<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineTrash - Cr√≠ticas √Åcidas de Cinema e TV</title>
    <meta name="description" content="Cr√≠ticas sinceras e √°cidas sobre filmes e s√©ries. Onde conte√∫do ruim √© elogio!">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            color: white;
            padding: 40px 0;
        }
        
        .logo {
            font-size: 4em;
            margin-bottom: 10px;
            animation: shake 2s infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        
        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .tagline {
            font-size: 1.3em;
            opacity: 0.95;
            margin-bottom: 20px;
        }
        
        .beta-badge {
            display: inline-block;
            background: #ff6b6b;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .search-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .api-status {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.85em;
        }
        
        .status-item {
            padding: 4px 12px;
            border-radius: 15px;
            background: #f0f0f0;
            text-align: center;
        }
        
        .status-item.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .search-controls {
            margin-bottom: 20px;
        }
        
        .content-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .type-btn {
            padding: 8px 20px;
            border: 2px solid #764ba2;
            border-radius: 20px;
            background: white;
            color: #764ba2;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .type-btn.active {
            background: #764ba2;
            color: white;
        }
        
        .type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .search-box {
            display: flex;
            gap: 10px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #764ba2;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a3785;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .demo-section {
            text-align: center;
            margin: 20px 0;
        }
        
        .demo-title {
            color: #666;
            margin-bottom: 15px;
        }
        
        .demo-categories {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .demo-category {
            text-align: center;
        }
        
        .demo-category h4 {
            color: #764ba2;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .demo-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .demo-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 6px 16px;
            border: 2px solid white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }
        
        .demo-btn:hover {
            background: white;
            color: #764ba2;
        }
        
        .content-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .content-header {
            display: flex;
            background: #f8f9fa;
            padding: 20px;
            gap: 20px;
        }
        
        .content-poster {
            width: 150px;
            height: 225px;
            border-radius: 10px;
            object-fit: cover;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .content-info {
            flex: 1;
        }
        
        .content-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 10px;
        }
        
        .content-meta {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .source-badge {
            display: inline-block;
            background: #764ba2;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-bottom: 10px;
        }
        
        .trash-rating {
            font-size: 2em;
            margin: 10px 0;
        }
        
        .content-body {
            padding: 20px;
        }
        
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #764ba2;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .badge {
            background: #ffd700;
            color: #333;
            padding: 3px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .section-content {
            line-height: 1.8;
            color: #444;
        }
        
        .section.acida {
            background: linear-gradient(135deg, #fff3cd 0%, #fff9e6 100%);
            border-left: 4px solid #ffc107;
        }
        
        .loading {
            opacity: 0.7;
            font-style: italic;
        }
        
        .error {
            color: #dc3545;
            font-style: italic;
        }
        
        footer {
            background: rgba(0,0,0,0.2);
            color: white;
            padding: 30px;
            margin-top: 50px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }
        
        .api-attributions {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .attribution-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .api-logo {
            height: 30px;
        }
        
        .disclaimer {
            font-size: 12px;
            opacity: 0.8;
            line-height: 1.6;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 600px) {
            h1 { font-size: 2em; }
            .content-header { flex-direction: column; }
            .content-poster { width: 100%; height: auto; }
            .demo-categories { flex-direction: column; gap: 15px; }
            .api-attributions { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">üóëÔ∏è</div>
            <h1>CineTrash</h1>
            <p class="tagline">Cr√≠ticas √°cidas de filmes e s√©ries</p>
            <span class="beta-badge">BETA - 100% Gr√°tis</span>
        </header>
        
        <div class="search-section">
            <div class="search-header">
                <h2>üé¨ Destrua um Conte√∫do</h2>
                <div class="api-status">
                    <div class="status-item" id="tmdbStatus">üé¨ TMDB: Desconectado</div>
                    <div class="status-item" id="tvmazeStatus">üì∫ TVMaze: Desconectado</div>
                    <div class="status-item" id="reviewsStatus">üéØ Reviews: Desconectado</div>
                </div>
            </div>
            
            <div class="search-controls">
                <div class="content-type-selector">
                    <button class="type-btn active" data-type="movie" onclick="selectContentType('movie')">
                        üé¨ Filmes
                    </button>
                    <button class="type-btn" data-type="tv" onclick="selectContentType('tv')">
                        üì∫ S√©ries
                    </button>
                    <button class="type-btn" data-type="both" onclick="selectContentType('both')">
                        üîç Ambos
                    </button>
                </div>
                
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Digite o nome do filme ou s√©rie..." disabled>
                    <button class="btn btn-primary" onclick="searchContent()" disabled id="searchBtn">
                        üîç Buscar
                    </button>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 10px;">
                <button class="btn btn-success" onclick="initializeApp()">
                    ‚ö° Ativar CineTrash
                </button>
            </div>
        </div>
        
        <div class="demo-section">
            <p class="demo-title">üéØ Exemplos r√°pidos:</p>
            <div class="demo-categories">
                <div class="demo-category">
                    <h4>üé¨ Filmes</h4>
                    <div class="demo-buttons">
                        <button class="demo-btn" onclick="quickSearch('Barbie', 'movie')">Barbie</button>
                        <button class="demo-btn" onclick="quickSearch('Transformers', 'movie')">Transformers</button>
                        <button class="demo-btn" onclick="quickSearch('Morbius', 'movie')">Morbius</button>
                    </div>
                </div>
                <div class="demo-category">
                    <h4>üì∫ S√©ries</h4>
                    <div class="demo-buttons">
                        <button class="demo-btn" onclick="quickSearch('Breaking Bad', 'tv')">Breaking Bad</button>
                        <button class="demo-btn" onclick="quickSearch('Game of Thrones', 'tv')">Game of Thrones</button>
                        <button class="demo-btn" onclick="quickSearch('The Office', 'tv')">The Office</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="contentResults"></div>
        
        <footer>
            <div class="api-attributions">
                <div class="attribution-item">
                    <img src="https://www.themoviedb.org/assets/2/v4/logos/v2/blue_square_1-5bdc75aaebeb75dc7ae79426ddd9be3b2be1e342510f8202baf6bffa71d7f5c4.svg" 
                         alt="TMDB" class="api-logo">
                    <span><strong>Filmes:</strong> TMDB API</span>
                </div>
                <div class="attribution-item">
                    <span style="font-size: 24px;">üì∫</span>
                    <span><strong>S√©ries:</strong> <a href="https://www.tvmaze.com" style="color: white;">TVMaze</a></span>
                </div>
                <div class="attribution-item">
                    <span style="font-size: 24px;">üéØ</span>
                    <span><strong>Reviews:</strong> TMDB + OMDb + An√°lises</span>
                </div>
            </div>
            
            <p class="disclaimer">
                ‚ö†Ô∏è <strong>AVISOS LEGAIS:</strong><br>
                ‚Ä¢ <strong>Filmes:</strong> Este site usa TMDB e as APIs do TMDB mas n√£o √© endossado, certificado ou aprovado pelo TMDB.<br>
                ‚Ä¢ <strong>S√©ries:</strong> Dados de TV fornecidos por <a href="https://www.tvmaze.com" style="color: white;">TVMaze</a> sob licen√ßa <a href="https://creativecommons.org/licenses/by-sa/4.0/" style="color: white;">CC BY-SA 4.0</a>.<br>
                ‚Ä¢ <strong>Reviews:</strong> Avalia√ß√µes obtidas de TMDB, OMDb (IMDb/Rotten Tomatoes) e an√°lises contextuais.<br>
                ‚Ä¢ Todas as cr√≠ticas s√£o opini√µes sat√≠ricas para fins de entretenimento.<br>
                ¬© 2024 CineTrash - Projeto educacional n√£o comercial
            </p>
        </footer>
    </div>

    <script>
        // === CONFIGURA√á√ïES DAS APIS ===
        const TMDB_API_KEY = 'd76cf4268b2dcb1b8f8064ee015e7c5d'; // TROQUE PELA SUA!
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const TMDB_IMG_BASE = 'https://image.tmdb.org/t/p/w500';
        
        const TVMAZE_BASE_URL = 'https://api.tvmaze.com';
        
        // Estado da aplica√ß√£o
        let currentContentType = 'movie';
        
        // === MOTOR DE CR√çTICAS EXPANDIDO ===
        const ROAST_DB = {
            // Bases por tipo de conte√∫do
            base_movie: [
                "Or√ßamento generoso para explodir {coisa} enquanto o roteiro tira f√©rias.",
                "A fotografia √© t√£o escura que o brilho da TV virou personagem.",
                "Se {ator} tivesse lido o roteiro at√© o fim, talvez tivesse dito 'passo'."
            ],
            base_tv: [
                "Temporadas suficientes para voc√™ repensar suas escolhas de vida.",
                "Plot que se arrasta mais que fila do SUS.",
                "Cancelaram no cliffhanger. At√© o Netflix tem d√≥ do espectador.",
                "Mais epis√≥dios que desenvolvimento de personagem.",
                "Showrunner mudou 3 vezes. Coer√™ncia narrativa pediu demiss√£o."
            ],
            
            // G√™neros expandidos para TV
            Drama: [
                "Sil√™ncios dram√°ticos t√£o longos que voc√™ rev√™ suas escolhas de vida.",
                "Close no olhar √∫mido resolve qualquer arco narrativo."
            ],
            Crime: [
                "Investiga√ß√£o que Sherlock Holmes resolveria em 20 minutos.",
                "Plot twist que voc√™ sacou no epis√≥dio piloto."
            ],
            Thriller: [
                "Tens√£o constru√≠da em 5 epis√≥dios, destru√≠da em 2 minutos de revela√ß√£o boba.",
                "Todo mundo √© suspeito, especialmente quem parece mais inocente."
            ],
            Comedy: [
                "Humor for√ßado que nem risada enlatada salvaria.",
                "Piadas explicadas duas vezes para garantir que ningu√©m ria."
            ],
            Fantasy: [
                "Or√ßamento de CGI que n√£o cobre nem drag√£o decente.",
                "Magia que resolve tudo exceto o roteiro."
            ],
            
            // Franquias de TV
            franquias_tv: {
                "Game of Thrones": [
                    "√öltima temporada t√£o ruim que fez todo mundo esquecer que gostava da s√©rie.",
                    "8 temporadas para isso? Drag√£o deveria ter queimado o roteiro."
                ],
                "The Walking Dead": [
                    "Morreu mais devagar que os pr√≥prios zumbis.",
                    "Sobreviveu mais que deveria. Igual aos personagens."
                ],
                "Lost": [
                    "Mist√©rios que nem os roteiristas sabiam como resolver.",
                    "Ilha misteriosa, roteiro mais misterioso ainda."
                ],
                "Breaking Bad": [
                    "T√£o viciante quanto a pr√≥pria metanfetamina. Pelo menos essa faz sentido."
                ]
            },
            
            // Elementos comuns
            base_all: [
                "Mais longo que precisava, menos profundo do que prometia.",
                "Existe. Pessoas foram pagas. Fim.",
                "Voc√™ termina de assistir e esquece antes de desligar a TV."
            ],
            
            coisas: ["carros","pr√©dios","helic√≥pteros","coer√™ncia","CGI duvidoso","plot twist","personagens","temporadas"]
        };
        
        // Templates de spoiler para s√©ries
        const spoilerTemplatesTv = [
            "No final da temporada, {ator} descobre que o real vil√£o era o showrunner.",
            "Cancelaram no cliffhanger. Netflix sendo Netflix.",
            "Plot twist: era tudo flashback do protagonista morrendo no piloto.",
            "√öltima temporada resolve tudo em 10 minutos. F√£s choram sangue.",
            "Vil√£o era o personagem que voc√™ mais gostava. Que original.",
            "Final aberto para temporada que nunca vai existir."
        ];
        
        // === FUN√á√ïES DE UTILIDADE ===
        function cyrb128(str){
            let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762;
            for(let i=0;i<str.length;i++){
                let ch=str.charCodeAt(i);
                h1=h2^Math.imul(h1^ch,597399067); h2=h3^Math.imul(h2^ch,2869860233);
                h3=h4^Math.imul(h3^ch,951274213); h4=h1^Math.imul(h4^ch,2716044179);
            }
            h1=Math.imul(h3^(h1>>>18),597399067); h2=Math.imul(h4^(h2>>>22),2869860233);
            h3=Math.imul(h1^(h3>>>17),951274213); h4=Math.imul(h2^(h4>>>19),2716044179);
            return [(h1^h2^h3^h4)>>>0];
        }
        
        function mulberry32(a){
            return function(){
                let t=a+=0x6D2B79F5;
                t=Math.imul(t^(t>>>15),t|1);
                t^=t+Math.imul(t^(t>>>7),t|61);
                return((t^(t>>>14))>>>0)/4294967296
            }
        }
        
        function pick(arr,rng){ 
            return (!arr || !arr.length) ? "" : arr[Math.floor(rng()*arr.length)] 
        }
        
        function templ(str, ctx){
            return str
                .replaceAll("{ator}", ctx.ator || "o protagonista")
                .replaceAll("{coisa}", pick(ROAST_DB.coisas, ctx.rng))
                .replaceAll("{numero}", String(1 + Math.floor(ctx.rng()*4)));
        }
        
        function computeTrashScore(rating, rng, isTV = false){
            let base = 3;
            if (typeof rating === "number") {
                // Para s√©ries, usar rating do TVMaze (0-10), para filmes TMDB (0-10)
                base = Math.ceil((10 - rating) / 1.5);
                base = Math.max(1, Math.min(5, base));
            }
            return base;
        }
        
        // === MOTOR DE CR√çTICAS PRINCIPAL ===
        function gerarCriticaConteudo({ title, year, genres = [], cast = [], rating, type = 'movie' }) {
            const seed = cyrb128(`${title}|${year}|${type}`)[0];
            const rng = mulberry32(seed);
            const ctx = { rng, ator: cast[0]?.name };
            
            const lines = [];
            const isTV = type === 'tv';
            
            // Base por tipo de conte√∫do
            const baseContent = isTV ? ROAST_DB.base_tv : ROAST_DB.base_movie;
            lines.push(pick(baseContent, rng));
            
            // Franquias espec√≠ficas de TV
            if (isTV && ROAST_DB.franquias_tv[title]) {
                lines.unshift(pick(ROAST_DB.franquias_tv[title], rng));
            }
            
            // G√™neros
            const primaryGenre = genres[0];
            if (primaryGenre && ROAST_DB[primaryGenre]) {
                lines.push(pick(ROAST_DB[primaryGenre], rng));
            }
            
            // Base geral
            for (let i = 0; i < 3; i++) {
                lines.push(pick(ROAST_DB.base_all, rng));
            }
            
            const uniqueLines = [...new Set(lines.filter(Boolean))].map(s => templ(s, ctx));
            
            const sinopse = `${title} (${year || "????"}). ${uniqueLines[0] || "Conte√∫do existe."}`;
            const analise = uniqueLines
                .slice(1, 4)
                .map(s => s.replace(/[.?!]\s*$/, ""))
                .join(". ") + ".";
            
            const spoilerTemplates = isTV ? spoilerTemplatesTv : [
                "No fim, {ator} descobre que o verdadeiro vil√£o era o contrato da sequ√™ncia.",
                "Plot twist: era tudo um sonho. Ou n√£o. Tanto faz.",
                "{ator} salva o dia com o poder do amor. S√©rio.",
                "Vil√£o era o amigo do come√ßo. Chocante como sempre."
            ];
            
            const spoiler = templ(pick(spoilerTemplates, rng), ctx);
            const trash_score = computeTrashScore(rating, rng, isTV);
            
            return { sinopse, analise, spoiler, trash_score };
        }
        
        // === FUN√á√ïES DA INTERFACE ===
        function selectContentType(type) {
            currentContentType = type;
            
            // Atualiza bot√µes
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // Atualiza placeholder
            const input = document.getElementById('searchInput');
            switch(type) {
                case 'movie':
                    input.placeholder = "Digite o nome do filme...";
                    break;
                case 'tv':
                    input.placeholder = "Digite o nome da s√©rie...";
                    break;
                case 'both':
                    input.placeholder = "Digite o nome do filme ou s√©rie...";
                    break;
            }
        }
        
        async function initializeApp() {
            const tmdbStatus = document.getElementById('tmdbStatus');
            const tvmazeStatus = document.getElementById('tvmazeStatus');
            const reviewsStatus = document.getElementById('reviewsStatus');
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            
            // Testa TMDB
            tmdbStatus.textContent = 'üé¨ TMDB: Conectando...';
            try {
                const response = await fetch(`${TMDB_BASE_URL}/configuration?api_key=${TMDB_API_KEY}`);
                if (response.ok) {
                    tmdbStatus.textContent = 'üé¨ TMDB: ‚úÖ Conectado';
                    tmdbStatus.classList.add('connected');
                } else {
                    throw new Error('TMDB connection failed');
                }
            } catch (error) {
                tmdbStatus.textContent = 'üé¨ TMDB: ‚ùå Erro';
            }
            
            // Testa TVMaze
            tvmazeStatus.textContent = 'üì∫ TVMaze: Conectando...';
            try {
                const response = await fetch(`${TVMAZE_BASE_URL}/shows/1`);
                if (response.ok) {
                    tvmazeStatus.textContent = 'üì∫ TVMaze: ‚úÖ Conectado';
                    tvmazeStatus.classList.add('connected');
                } else {
                    throw new Error('TVMaze connection failed');
                }
            } catch (error) {
                tvmazeStatus.textContent = 'üì∫ TVMaze: ‚ùå Erro';
            }
            
            // Testa API de Reviews
            reviewsStatus.textContent = 'üéØ Reviews: Testando...';
            try {
                const response = await fetch('/api/reddit?title=test&type=movie');
                if (response.ok) {
                    reviewsStatus.textContent = 'üéØ Reviews: ‚úÖ Conectado';
                    reviewsStatus.classList.add('connected');
                } else {
                    throw new Error('Reviews API connection failed');
                }
            } catch (error) {
                reviewsStatus.textContent = 'üéØ Reviews: ‚ùå Erro';
                console.warn('Reviews API test failed:', error);
            }
            
            // Ativa interface
            searchInput.disabled = false;
            searchBtn.disabled = false;
            searchInput.focus();
        }
        
        const _translateCache = new Map();

        function _looksPtBR(s) {
            return /[√£√µ√°√©√≠√≥√∫√†√™√¢√¥√ß]/i.test(s); // heur√≠stica simples
        }

        function _stripHtml(s) {
            return (s || "").replace(/<[^>]*>/g, "");
        }

        async function translateText(text, fromLang = "en", toLang = "pt-BR") {
            if (!text) return text;
            // remove tags se vier de TVMaze
            const clean = _stripHtml(text).trim();
            if (!clean) return "";

            // j√° √© portugu√™s? devolve direto
            if (_looksPtBR(clean)) return clean;

            // cache
            const cacheKey = `${fromLang}|${toLang}|${clean}`;
            if (_translateCache.has(cacheKey)) return _translateCache.get(cacheKey);

            // MyMemory limita ~500 chars ‚Äì use 480 para margem
            const MAX = 480;
            const chunks = [];
            for (let i = 0; i < clean.length; i += MAX) {
                chunks.push(clean.slice(i, i + MAX));
            }

            const out = [];
            for (const part of chunks) {
                try {
                    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(part)}&langpair=${fromLang}|${toLang}`;
                    const resp = await fetch(url);
                    const data = await resp.json();
                    const ok = data?.responseStatus === 200 && data?.responseData?.translatedText;
                    out.push(ok ? data.responseData.translatedText : part);
                    // delay para respeitar cota
                    await new Promise(r => setTimeout(r, 150));
                } catch {
                    out.push(part); // fallback
                }
            }

            const finalText = out.join("");
            _translateCache.set(cacheKey, finalText);
            return finalText;
        }

        function htmlEscape(s){
            return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
        }

        // === FUN√á√ÉO PARA BUSCAR REVIEWS H√çBRIDOS ===
        async function loadReviews(title, type, year = '', tmdbId = '', rating = 7.0) {
            const reviewsArea = document.getElementById("reviewsArea");
            if (!reviewsArea) {
                console.warn("Reviews area not found");
                return;
            }

            // Loading state
            reviewsArea.innerHTML = `<div class="loading">üîÑ Buscando avalia√ß√µes de m√∫ltiplas fontes...</div>`;

            try {
                const params = new URLSearchParams({
                    title: title || "",
                    year: year || "",
                    type: type || "",
                    tmdb_id: tmdbId || "",
                    rating: rating.toString(),
                    genres: "" // Ser√° preenchido se dispon√≠vel
                });

                const response = await fetch(`/api/reddit?${params.toString()}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const reviews = data.reviews || [];

                console.log('Reviews data received:', data);

                if (!reviews.length) {
                    reviewsArea.innerHTML = `
                        <div style="opacity: 0.7;">
                            ü§∑‚Äç‚ôÇÔ∏è Nenhuma avalia√ß√£o encontrada para este t√≠tulo.
                        </div>
                    `;
                    return;
                }

                // Monta lista de reviews com fontes variadas
                const reviewsHtml = await Promise.all(
                    reviews.slice(0, 6).map(async (review, index) => {
                        try {
                            // Traduz apenas reviews em ingl√™s (fonte TMDB principalmente)
                            const shouldTranslate = review.source === 'TMDB' && review.text.length > 50;
                            const translatedText = shouldTranslate 
                                ? await translateText(review.text, "en", "pt-BR")
                                : review.text;
                            
                            // Determina √≠cone por fonte
                            let sourceIcon = 'üí¨';
                            if (review.source === 'TMDB') sourceIcon = 'üé¨';
                            else if (review.source === 'OMDb') sourceIcon = '‚≠ê';
                            else if (review.source === 'Sint√©tico') sourceIcon = 'ü§ñ';
                            
                            return `
                                <li style="margin-bottom: 18px; line-height: 1.6; border-left: 3px solid #764ba2; padding-left: 15px; background: rgba(118, 75, 162, 0.05); border-radius: 8px; padding: 15px;">
                                    <div style="margin-bottom: 10px;">
                                        "${htmlEscape(translatedText)}"
                                    </div>
                                    <div style="font-size: 0.85em; opacity: 0.75; display: flex; justify-content: space-between; align-items: center;">
                                        <span>
                                            ${sourceIcon} <strong>${htmlEscape(review.author)}</strong> ‚Ä¢ 
                                            üìä ${review.score}/100 ‚Ä¢
                                            <em>${review.source}</em>
                                            ${review.date ? ` ‚Ä¢ ${review.date}` : ''}
                                        </span>
                                        ${review.link ? `<a href="${review.link}" target="_blank" rel="noopener" style="color: #764ba2; font-size: 12px;">ver original</a>` : ''}
                                    </div>
                                </li>
                            `;
                        } catch (error) {
                            console.warn(`Translation failed for review ${index}:`, error);
                            return `
                                <li style="margin-bottom: 18px; line-height: 1.6; border-left: 3px solid #764ba2; padding-left: 15px; background: rgba(118, 75, 162, 0.05); border-radius: 8px; padding: 15px;">
                                    <div style="margin-bottom: 10px;">
                                        "${htmlEscape(review.text)}"
                                    </div>
                                    <div style="font-size: 0.85em; opacity: 0.75;">
                                        üí¨ <strong>${htmlEscape(review.author)}</strong> ‚Ä¢ 
                                        üìä ${review.score}/100 ‚Ä¢ 
                                        <em>${review.source}</em>
                                        ${review.link ? ` ‚Ä¢ <a href="${review.link}" target="_blank" rel="noopener" style="color: #764ba2;">ver original</a>` : ''}
                                    </div>
                                </li>
                            `;
                        }
                    })
                );

                reviewsArea.innerHTML = `
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        ${reviewsHtml.join("")}
                    </ul>
                `;

                // Mostra fontes utilizadas
                if (data.sources && data.sources.length > 0) {
                    const sourcesInfo = document.createElement('div');
                    sourcesInfo.style.cssText = "font-size: 11px; opacity: 0.6; margin-top: 15px; font-style: italic; border-top: 1px solid #eee; padding-top: 10px;";
                    sourcesInfo.innerHTML = `üìà Fontes: ${data.sources.join(', ')}`;
                    reviewsArea.appendChild(sourcesInfo);
                }

                // Debug info
                if (data.debug) {
                    console.log('Reviews API debug info:', data.debug);
                }

            } catch (error) {
                console.error("Reviews fetch failed:", error);
                reviewsArea.innerHTML = `
                    <div class="error">
                        üí• Erro ao buscar avalia√ß√µes. Tente novamente em alguns minutos.
                    </div>
                `;
            }
        }
        
        // === FUN√á√ïES DE BUSCA ===
        async function searchTMDB(query) {
            try {
                const response = await fetch(
                    `${TMDB_BASE_URL}/search/movie?api_key=${TMDB_API_KEY}&language=pt-BR&query=${encodeURIComponent(query)}`
                );
                const data = await response.json();
                const movie = data.results?.[0];
                
                if (!movie) return null;
                
                // Busca detalhes completos
                const [detailsResp, creditsResp] = await Promise.all([
                    fetch(`${TMDB_BASE_URL}/movie/${movie.id}?api_key=${TMDB_API_KEY}&language=pt-BR`),
                    fetch(`${TMDB_BASE_URL}/movie/${movie.id}/credits?api_key=${TMDB_API_KEY}&language=pt-BR`)
                ]);
                
                const details = detailsResp.ok ? await detailsResp.json() : {};
                const credits = creditsResp.ok ? await creditsResp.json() : {};
                
                return {
                    type: 'movie',
                    source: 'TMDB',
                    title: movie.title,
                    year: (movie.release_date || '').slice(0, 4),
                    genres: details.genres?.map(g => g.name) || [],
                    cast: (credits.cast || []).slice(0, 3),
                    rating: movie.vote_average,
                    overview: movie.overview,
                    poster: movie.poster_path 
                        ? `${TMDB_IMG_BASE}${movie.poster_path}` 
                        : 'https://via.placeholder.com/150x225/764ba2/ffffff?text=Poster',
                    tmdb_id: movie.id,
                    original_data: movie
                };
            } catch (error) {
                console.error('Erro TMDB:', error);
                return null;
            }
        }
        
        async function searchTVMaze(query) {
            try {
                const res = await fetch(`${TVMAZE_BASE_URL}/search/shows?q=${encodeURIComponent(query)}`);
                const arr = await res.json();
                const show = arr?.[0]?.show;
                if (!show) return null;

                // detalhes + elenco
                const dres = await fetch(`${TVMAZE_BASE_URL}/shows/${show.id}?embed=cast`);
                const det = await dres.json();
                const cast = (det._embedded?.cast || []).slice(0,3).map(c => ({ name: c?.person?.name || "" }));

                // Extrai sinopse e remove HTML
                let overview = det.summary ? det.summary.replace(/<[^>]*>/g,'') : 'Sem sinopse dispon√≠vel.';
                
                // Traduz sinopse se n√£o estiver vazia e for maior que 10 caracteres
                if (overview && overview !== 'Sem sinopse dispon√≠vel.' && overview.length > 10) {
                    overview = await translateText(overview);
                }

                return {
                    type: 'tv',
                    source: 'TVMaze',
                    title: det.name || show.name,
                    year: (det.premiered || show.premiered || '').slice(0,4),
                    genres: det.genres || show.genres || [],
                    cast,
                    rating: (det.rating && typeof det.rating.average === 'number') ? det.rating.average : null,
                    overview,
                    poster: det.image?.original || det.image?.medium || 'https://via.placeholder.com/150x225/764ba2/ffffff?text=Poster',
                    network: det.network?.name || det.webChannel?.name || 'Desconhecido',
                    status: det.status || '‚Äî',
                    tmdb_id: '',
                    original_data: det
                };
            } catch (e) {
                console.error('Erro TVMaze:', e);
                return null;
            }
        }
        
        async function searchContent() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('Digite algo para destruir! üòà');
                return;
            }
            
            const results = document.getElementById('contentResults');
            results.innerHTML = '<div style="text-align:center;color:white;padding:20px;">üîç Procurando conte√∫do para destruir...</div>';
            
            const searchPromises = [];
            
            if (currentContentType === 'movie' || currentContentType === 'both') {
                searchPromises.push(searchTMDB(query));
            }
            
            if (currentContentType === 'tv' || currentContentType === 'both') {
                searchPromises.push(searchTVMaze(query));
            }
            
            try {
                const searchResults = await Promise.all(searchPromises);
                const validResults = searchResults.filter(result => result !== null);
                
                if (validResults.length === 0) {
                    results.innerHTML = '<div style="text-align:center;color:white;padding:20px;">ü§∑‚Äç‚ôÇÔ∏è Nenhum conte√∫do encontrado...</div>';
                    return;
                }
                
                // Mostra primeiro resultado encontrado
                const content = validResults[0];
                displayContent(content);
                
            } catch (error) {
                console.error('Erro na busca:', error);
                results.innerHTML = '<div style="text-align:center;color:white;padding:20px;">üí• Erro na busca. Tente novamente.</div>';
            }
        }
        
        function displayContent(content) {
            const critica = gerarCriticaConteudo({
                title: content.title,
                year: content.year,
                genres: content.genres,
                cast: content.cast,
                rating: content.rating,
                type: content.type
            });
            
            const trash = 'üóëÔ∏è'.repeat(critica.trash_score);
            const ratingDisplay = content.rating !== null ? content.rating.toFixed(1) : 'N/A';
            
            const extraInfo = content.type === 'tv' 
                ? `üì∫ Rede: ${content.network}<br>üìä Status: ${content.status}<br>`
                : '';
            
            const typeIcon = content.type === 'tv' ? 'üì∫' : 'üé¨';
            const typeLabel = content.type === 'tv' ? 'S√©rie' : 'Filme';
            
            const results = document.getElementById('contentResults');
            results.innerHTML = `
                <div class="content-card">
                    <div class="content-header">
                        <img src="${content.poster}" alt="Poster" class="content-poster">
                        <div class="content-info">
                            <h2 class="content-title">${content.title}</h2>
                            <div class="source-badge">${content.source}</div>
                            <div class="content-meta">
                                ${typeIcon} Tipo: ${typeLabel}<br>
                                üìÖ Ano: ${content.year || '????'}<br>
                                ‚≠ê Nota: ${ratingDisplay}/10<br>
                                üé¨ G√™nero: ${content.genres.join(', ') || '‚Äî'}<br>
                                ${extraInfo}
                            </div>
                            <div class="trash-rating" title="Trash score (1-5)">${trash}</div>
                        </div>
                    </div>

                    <div class="content-body">
                        <div class="section">
                            <div class="section-header">
                                <div class="section-title">üìù SINOPSE ORIGINAL</div>
                            </div>
                            <div class="section-content" id="synopsisArea">
                                ${content.overview}
                            </div>
                        </div>

                        <div class="section acida">
                            <div class="section-header">
                                <div class="section-title">üòà CR√çTICA √ÅCIDA</div>
                                <span class="badge">MOTOR SAT√çRICO</span>
                            </div>
                            <div class="section-content"><strong>${critica.sinopse}</strong></div>
                        </div>

                        <div class="section">
                            <div class="section-header">
                                <div class="section-title">üß™ AN√ÅLISE PROFUNDA</div>
                            </div>
                            <div class="section-content">${critica.analise}</div>
                        </div>

                        <div class="section">
                            <div class="section-header">
                                <div class="section-title">üéØ AVALIA√á√ïES REAIS</div>
                            </div>
                            <div class="section-content" id="reviewsArea">‚Äî</div>
                            <div style="font-size:12px;opacity:.65;margin-top:6px">
                                Reviews de TMDB, ratings do OMDb/IMDb/Rotten Tomatoes e an√°lises contextuais ‚Ä¢ clique para ver fontes originais.
                            </div>
                        </div>

                        <div class="section">
                            <div class="section-header">
                                <div class="section-title">ü§´ SPOILER SARC√ÅSTICO</div>
                            </div>
                            <div class="section-content">${critica.spoiler}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // üîÑ Tradu√ß√£o ass√≠ncrona da sinopse
            const synopsisEl = document.getElementById("synopsisArea");
            if (content.overview) {
                translateText(content.overview, "en", "pt-BR").then(translated => {
                    if (translated && translated !== content.overview) {
                        synopsisEl.textContent = translated;
                    }
                }).catch(error => {
                    console.warn("Translation failed:", error);
                });
            }

            // Chama a fun√ß√£o para carregar reviews
            loadReviews(content.title, content.type, content.year, content.tmdb_id, content.rating);
        }
        
        function quickSearch(query, type = null) {
            if (type) {
                selectContentType(type);
            }
            document.getElementById('searchInput').value = query;
            if (!document.getElementById('searchBtn').disabled) {
                searchContent();
            } else {
                alert('Clique em "Ativar CineTrash" primeiro! ‚ö°');
            }
        }
        
        // Enter para buscar
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !this.disabled) {
                searchContent();
            }
        });
    </script>
</body>
</html>